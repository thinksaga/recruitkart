generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Enums (The State Machine) ---

enum UserRole {
  ADMIN
  SUPPORT
  OPERATOR
  TAS
  // Company Roles
  COMPANY_ADMIN
  COMPANY_MEMBER
  INTERVIEWER
  DECISION_MAKER
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum JobStatus {
  DRAFT
  OPEN
  PRIVATE
  CLOSED
  FILLED
}

enum SubmissionStatus {
  PENDING_CONSENT
  LOCKED
  ACTIVE
  REJECTED_BY_CANDIDATE
  EXPIRED
  INTERVIEWING
  HIRED
}

enum EscrowStatus {
  HELD
  RELEASED_TO_TAS
  REFUNDED_TO_COMPANY
  DISPUTED
}

enum InterviewStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
}

enum InterviewOutcome {
  PASSED
  REJECTED
  NEXT_ROUND_NEEDED
  PENDING_DECISION
}

enum InvitationStatus {
  PENDING
  ACCEPTED
}

enum TicketStatus {
  OPEN
  RESOLVED
}

// --- Core Models ---

model User {
  id                  String             @id @default(uuid())
  email               String             @unique
  password_hash       String
  role                UserRole
  verification_status VerificationStatus @default(PENDING)
  organization_id     String?
  reset_token         String?
  reset_token_expiry  DateTime?
  created_at          DateTime           @default(now())
  updated_at          DateTime           @updatedAt

  // Relations
  organization Organization? @relation(fields: [organization_id], references: [id])
  tas_profile  TASProfile?
  tickets      Ticket[]
}

model Organization {
  id         String   @id @default(uuid())
  name       String
  gstin      String?
  domain     String?
  website    String?
  logo_url   String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  users       User[]
  jobs        Job[]
  invitations Invitation[]
}

model Invitation {
  id              String           @id @default(uuid())
  email           String
  role            UserRole
  organization_id String
  token           String           @unique
  status          InvitationStatus @default(PENDING)
  expires_at      DateTime
  created_at      DateTime         @default(now())
  updated_at      DateTime         @updatedAt

  // Relations
  organization Organization @relation(fields: [organization_id], references: [id])

  @@unique([email, organization_id])
}

model TASProfile {
  id              String   @id @default(uuid())
  user_id         String   @unique
  pan_number      String   @unique
  linkedin_url    String?
  credits_balance Int      @default(0)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  // Relations
  user        User         @relation(fields: [user_id], references: [id])
  submissions Submission[]
}

model Job {
  id                 String    @id @default(uuid())
  organization_id    String
  title              String
  description        String?
  salary_min         Float?
  salary_max         Float?
  status             JobStatus @default(DRAFT)
  infra_fee_paid     Boolean   @default(false)
  success_fee_amount Float
  created_at         DateTime  @default(now())
  updated_at         DateTime  @updatedAt

  // Relations
  organization  Organization  @relation(fields: [organization_id], references: [id])
  escrow_ledger EscrowLedger?
  submissions   Submission[]
  tickets       Ticket[]
}

model Candidate {
  id            String  @id @default(uuid())
  phone         String  @unique
  email         String  @unique
  full_name     String
  identity_hash String? // For fuzzy deduplication

  // Structured Data (Replacing generic JSON)
  personal_details  Json? // { current_location, preferred_locations, notice_period, ctc... }
  work_history      Json? // Array of { company, role, start, end, description... }
  education_history Json? // Array of { institution, degree, year... }
  social_links      Json? // { linkedin, github, portfolio... }

  // Search Optimization
  skills_primary   String[] // Top 5 skills for indexing
  skills_secondary String[] // All other tags

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  submissions Submission[]

  // Index for fast skill search
  @@index([skills_primary])
}

model Submission {
  id           String           @id @default(uuid())
  job_id       String
  tas_id       String
  candidate_id String
  status       SubmissionStatus @default(PENDING_CONSENT)
  locked_until DateTime?
  created_at   DateTime         @default(now())
  updated_at   DateTime         @updatedAt

  // Relations
  job        Job         @relation(fields: [job_id], references: [id])
  tas        TASProfile  @relation(fields: [tas_id], references: [id])
  candidate  Candidate   @relation(fields: [candidate_id], references: [id])
  interviews Interview[]

  // Constraint: A candidate can be submitted to a job only once
  @@unique([job_id, candidate_id])
}

model Interview {
  id              String           @id @default(uuid())
  submission_id   String
  round_number    Int              @default(1)
  round_type      String // e.g., "Technical", "HR", "Coding"
  status          InterviewStatus  @default(SCHEDULED)
  outcome         InterviewOutcome @default(PENDING_DECISION)
  feedback_json   Json? // JSONB for scorecard
  zoom_meeting_id String?
  recording_url   String?
  scheduled_at    DateTime?
  created_at      DateTime         @default(now())
  updated_at      DateTime         @updatedAt

  // Relations
  submission Submission @relation(fields: [submission_id], references: [id])
}

model Ticket {
  id              String       @id @default(uuid())
  raised_by_id    String
  related_job_id  String?
  reason          String
  status          TicketStatus @default(OPEN)
  resolution_note String?
  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt

  // Relations
  raised_by   User @relation(fields: [raised_by_id], references: [id])
  related_job Job? @relation(fields: [related_job_id], references: [id])
}

model EscrowLedger {
  id           String       @id @default(uuid())
  job_id       String       @unique
  amount       Float
  status       EscrowStatus @default(HELD)
  deposited_at DateTime     @default(now())
  release_date DateTime?
  created_at   DateTime     @default(now())
  updated_at   DateTime     @updatedAt

  // Relations
  job Job @relation(fields: [job_id], references: [id])
}
